<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Advanced Template Customizer</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>

        .template-preview {

            border: 1px solid #ddd;

            padding: 15px;

            margin-bottom: 20px;

            position: relative;

            height: 600px;

            overflow: auto;

        }

        

        .template-preview iframe {

            width: 100%;

            height: 100%;

            border: none;

        }

        

        .controls {

            background: #f8f9fa;

            padding: 15px;

            border-radius: 5px;

            margin-bottom: 20px;

        }

        

        .element-list {

            max-height: 500px;

            overflow-y: auto;

        }

        

        .element-category {

            margin-bottom: 15px;

        }

        

        .element-category-header {

            background: #e9ecef;

            padding: 8px 12px;

            border-radius: 4px;

            margin-bottom: 8px;

            cursor: pointer;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }

        

        .element-items {

            padding-left: 15px;

        }

        

        .removable-element {

            cursor: pointer;

            padding: 8px;

            margin: 5px 0;

            background: #fff;

            border: 1px solid #ddd;

            border-radius: 4px;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }

        

        .removable-element:hover {

            background: #f1f1f1;

        }

        

        .removable-element.selected {

            background: #d4edda;

            border-color: #c3e6cb;

        }

        

        .preview-controls {

            margin-top: 10px;

            display: flex;

            justify-content: space-between;

        }

        

        .tab-content {

            padding-top: 15px;

        }

        

        .color-option {

            width: 25px;

            height: 25px;

            border-radius: 50%;

            display: inline-block;

            margin: 0 5px;

            cursor: pointer;

            border: 2px solid transparent;

        }

        

        .color-option.selected {

            border-color: #333;

        }

        

        .media-item {

            border: 1px solid #ddd;

            padding: 10px;

            margin-bottom: 10px;

            border-radius: 4px;

        }

        

        .media-item img {

            max-width: 100%;

            height: auto;

            margin-bottom: 10px;

        }

        

        .media-controls {

            display: flex;

            justify-content: space-between;

        }

    </style>

</head>

<body>

    <div class="container-fluid mt-4">

        <h1 class="mb-4">Advanced Template Customizer</h1>

        

        <div class="row">

            <div class="col-md-8">

                <div class="template-preview" id="previewContainer">

                    <iframe id="templatePreview" src="/template1"></iframe>

                </div>

                

                <div class="preview-controls">

                    <button class="btn btn-secondary" id="resetBtn">Reset Changes</button>

                    <div>

                        <button class="btn btn-success me-2" id="previewBtn">Preview</button>

                        <button class="btn btn-primary" id="generateZipBtn">Generate ZIP</button>

                    </div>

                </div>

            </div>

            

            <div class="col-md-4">

                <div class="controls">

                    <ul class="nav nav-tabs" id="customizeTabs" role="tablist">

                        <li class="nav-item" role="presentation">

                            <button class="nav-link active" id="elements-tab" data-bs-toggle="tab" data-bs-target="#elements" type="button" role="tab">Elements</button>

                        </li>

                        <li class="nav-item" role="presentation">

                            <button class="nav-link" id="colors-tab" data-bs-toggle="tab" data-bs-target="#colors" type="button" role="tab">Colors</button>

                        </li>

                        <li class="nav-item" role="presentation">

                            <button class="nav-link" id="media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button" role="tab">Media</button>

                        </li>

                        <li class="nav-item" role="presentation">

                            <button class="nav-link" id="fonts-tab" data-bs-toggle="tab" data-bs-target="#fonts" type="button" role="tab">Fonts</button>

                        </li>

                    </ul>

                    

                    <div class="tab-content" id="customizeTabsContent">

                        <!-- Elements Tab -->

                        <div class="tab-pane fade show active" id="elements" role="tabpanel">

                            <div class="mb-3">

                                <input type="text" class="form-control" id="elementSearch" placeholder="Search elements...">

                            </div>

                            

                            <div class="element-list" id="elementList">

                                <!-- Header Elements -->

                                <div class="element-category">

                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#headerElements">

                                        <span>Header</span>

                                        <i class="fas fa-chevron-down"></i>

                                    </div>

                                    <div class="collapse show element-items" id="headerElements">

                                        <div class="removable-element" data-element-id="header-logo">

                                            <span>Logo</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="header-nav">

                                            <span>Navigation Menu</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="header-cta">

                                            <span>Call-to-Action Button</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                

                                <!-- Hero Section Elements -->

                                <div class="element-category">

                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#heroElements">

                                        <span>Hero Section</span>

                                        <i class="fas fa-chevron-down"></i>

                                    </div>

                                    <div class="collapse show element-items" id="heroElements">

                                        <div class="removable-element" data-element-id="hero-heading">

                                            <span>Main Heading</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="hero-subheading">

                                            <span>Subheading</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="hero-image">

                                            <span>Hero Image</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="hero-cta">

                                            <span>Call-to-Action Button</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                

                                <!-- About Section Elements -->

                                <div class="element-category">

                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#aboutElements">

                                        <span>About Section</span>

                                        <i class="fas fa-chevron-down"></i>

                                    </div>

                                    <div class="collapse show element-items" id="aboutElements">

                                        <div class="removable-element" data-element-id="about-heading">

                                            <span>Heading</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="about-text">

                                            <span>Description Text</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="about-image">

                                            <span>Image</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                

                                <!-- Additional sections similar to above -->

                                <div class="element-category">

                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#footerElements">

                                        <span>Footer</span>

                                        <i class="fas fa-chevron-down"></i>

                                    </div>

                                    <div class="collapse show element-items" id="footerElements">

                                        <div class="removable-element" data-element-id="footer-logo">

                                            <span>Logo</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="footer-links">

                                            <span>Navigation Links</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="footer-social">

                                            <span>Social Media Icons</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                        <div class="removable-element" data-element-id="footer-copyright">

                                            <span>Copyright Text</span>

                                            <div>

                                                <i class="fas fa-eye"></i>

                                                <i class="fas fa-edit ms-2"></i>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                            </div>

                        </div>

                        

                        <!-- Colors Tab -->

                        <div class="tab-pane fade" id="colors" role="tabpanel">

                            <h5>Primary Color</h5>

                            <div class="mb-3">

                                <div class="color-option selected" style="background-color: #4e73df;" data-color="#4e73df"></div>

                                <div class="color-option" style="background-color: #1cc88a;" data-color="#1cc88a"></div>

                                <div class="color-option" style="background-color: #36b9cc;" data-color="#36b9cc"></div>

                                <div class="color-option" style="background-color: #f6c23e;" data-color="#f6c23e"></div>

                                <div class="color-option" style="background-color: #e74a3b;" data-color="#e74a3b"></div>

                                <div class="color-option" style="background-color: #5a5c69;" data-color="#5a5c69"></div>

                                <input type="color" id="customPrimaryColor" class="form-control form-control-sm mt-2" value="#4e73df">

                            </div>

                            

                            <h5>Secondary Color</h5>

                            <div class="mb-3">

                                <div class="color-option selected" style="background-color: #858796;" data-color="#858796"></div>

                                <div class="color-option" style="background-color: #f8f9fc;" data-color="#f8f9fc"></div>

                                <div class="color-option" style="background-color: #e3e6f0;" data-color="#e3e6f0"></div>

                                <div class="color-option" style="background-color: #d1d3e2;" data-color="#d1d3e2"></div>

                                <div class="color-option" style="background-color: #b7b9cc;" data-color="#b7b9cc"></div>

                                <input type="color" id="customSecondaryColor" class="form-control form-control-sm mt-2" value="#858796">

                            </div>

                            

                            <h5>Background Color</h5>

                            <div>

                                <div class="color-option selected" style="background-color: #ffffff;" data-color="#ffffff"></div>

                                <div class="color-option" style="background-color: #f8f9fc;" data-color="#f8f9fc"></div>

                                <div class="color-option" style="background-color: #f0f0f0;" data-color="#f0f0f0"></div>

                                <div class="color-option" style="background-color: #eeeeee;" data-color="#eeeeee"></div>

                                <input type="color" id="customBgColor" class="form-control form-control-sm mt-2" value="#ffffff">

                            </div>

                        </div>

                        

                        <!-- Media Tab -->

                        <div class="tab-pane fade" id="media" role="tabpanel">

                            <div class="mb-3">

                                <label for="uploadMedia" class="form-label">Upload New Media</label>

                                <input class="form-control" type="file" id="uploadMedia">

                                <button class="btn btn-outline-primary btn-sm mt-2" id="uploadBtn">Upload</button>

                            </div>

                            

                            <h5 class="mb-3">Template Media</h5>

                            <div id="mediaList">

                                <div class="media-item">

                                    <img src="/api/placeholder/150/100" alt="Hero Image">

                                    <div class="media-controls">

                                        <span>hero-image.jpg</span>

                                        <div>

                                            <button class="btn btn-sm btn-outline-primary replace-media">Replace</button>

                                            <button class="btn btn-sm btn-outline-danger ms-2 remove-media">Remove</button>

                                        </div>

                                    </div>

                                </div>

                                

                                <div class="media-item">

                                    <img src="/api/placeholder/150/100" alt="About Image">

                                    <div class="media-controls">

                                        <span>about-image.jpg</span>

                                        <div>

                                            <button class="btn btn-sm btn-outline-primary replace-media">Replace</button>

                                            <button class="btn btn-sm btn-outline-danger ms-2 remove-media">Remove</button>

                                        </div>

                                    </div>

                                </div>

                                

                                <div class="media-item">

                                    <img src="/api/placeholder/150/100" alt="Logo">

                                    <div class="media-controls">

                                        <span>logo.png</span>

                                        <div>

                                            <button class="btn btn-sm btn-outline-primary replace-media">Replace</button>

                                            <button class="btn btn-sm btn-outline-danger ms-2 remove-media">Remove</button>

                                        </div>

                                    </div>

                                </div>

                            </div>

                        </div>

                        

                        <!-- Fonts Tab -->

                        <div class="tab-pane fade" id="fonts" role="tabpanel">

                            <div class="mb-3">

                                <label for="headingFont" class="form-label">Heading Font</label>

                                <select class="form-select" id="headingFont">

                                    <option value="Arial, sans-serif">Arial</option>

                                    <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>

                                    <option value="'Open Sans', sans-serif" selected>Open Sans</option>

                                    <option value="'Roboto', sans-serif">Roboto</option>

                                    <option value="'Montserrat', sans-serif">Montserrat</option>

                                    <option value="'Lato', sans-serif">Lato</option>

                                    <option value="Georgia, serif">Georgia</option>

                                    <option value="'Times New Roman', Times, serif">Times New Roman</option>

                                </select>

                            </div>

                            

                            <div class="mb-3">

                                <label for="bodyFont" class="form-label">Body Font</label>

                                <select class="form-select" id="bodyFont">

                                    <option value="Arial, sans-serif">Arial</option>

                                    <option value="'Helvetica Neue', Helvetica, sans-serif" selected>Helvetica</option>

                                    <option value="'Open Sans', sans-serif">Open Sans</option>

                                    <option value="'Roboto', sans-serif">Roboto</option>

                                    <option value="'Montserrat', sans-serif">Montserrat</option>

                                    <option value="'Lato', sans-serif">Lato</option>

                                    <option value="Georgia, serif">Georgia</option>

                                    <option value="'Times New Roman', Times, serif">Times New Roman</option>

                                </select>

                            </div>

                            

                            <div class="mb-3">

                                <label for="headingSize" class="form-label">Heading Size</label>

                                <div class="input-group">

                                    <input type="range" class="form-range" id="headingSize" min="16" max="72" value="32">

                                    <span class="ms-2" id="headingSizeValue">32px</span>

                                </div>

                            </div>

                            

                            <div class="mb-3">

                                <label for="bodySize" class="form-label">Body Text Size</label>

                                <div class="input-group">

                                    <input type="range" class="form-range" id="bodySize" min="12" max="24" value="16">

                                    <span class="ms-2" id="bodySizeValue">16px</span>

                                </div>

                            </div>

                        </div>

                    </div>

                </div>

                

                <!-- Element Edit Modal -->

                <div class="modal fade" id="editElementModal" tabindex="-1" aria-hidden="true">

                    <div class="modal-dialog">

                        <div class="modal-content">

                            <div class="modal-header">

                                <h5 class="modal-title" id="editElementTitle">Edit Element</h5>

                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                            </div>

                            <div class="modal-body">

                                <div class="mb-3">

                                    <label for="elementText" class="form-label">Text Content</label>

                                    <input type="text" class="form-control" id="elementText">

                                </div>

                                <div class="mb-3">

                                    <label for="elementStyle" class="form-label">Custom CSS</label>

                                    <textarea class="form-control" id="elementStyle" rows="3"></textarea>

                                </div>

                            </div>

                            <div class="modal-footer">

                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                                <button type="button" class="btn btn-primary" id="saveElementChanges">Save Changes</button>

                            </div>

                        </div>

                    </div>

                </div>

                

                <form id="zipForm" action="/generate-zip" method="post" style="display:none;">

                    <input type="hidden" name="template_id" value="1">

                    <!-- Hidden inputs for customization options will be added dynamically -->

                </form>

            </div>

        </div>

    </div>

    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            // Store original iframe content and customization state
            let iframe = document.getElementById('templatePreview');
            let removedElements = [];
            let modifiedElements = {};
            let selectedColors = {
                primary: '#4e73df',
                secondary: '#858796',
                background: '#ffffff'
            };
            let selectedFonts = {
                heading: "'Open Sans', sans-serif",
                body: "'Helvetica Neue', Helvetica, sans-serif",
                headingSize: '32px',
                bodySize: '16px'
            };
            let modifiedMedia = {};
            
            // Initialize customizer functionality
            // We need to ensure the iframe is fully loaded before initializing
            if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                initializeCustomizer();
            } else {
                iframe.addEventListener('load', function() {
                    initializeCustomizer();
                });
            }
            
            function initializeCustomizer() {
                console.log("Initializing customizer...");
                
                // Initialize element toggle functionality
                $('.removable-element').off('click').on('click', function(e) {
                    if (!$(e.target).hasClass('fa-eye') && !$(e.target).hasClass('fa-edit')) {
                        $(this).toggleClass('selected');
                        const elementId = $(this).data('element-id');
                        console.log("Element clicked:", elementId);
                        
                        // Toggle visibility when selecting/deselecting element
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const element = iframeDoc.getElementById(elementId);
                        
                        if (element) {
                            if ($(this).hasClass('selected')) {
                                // Element selected for removal - hide it
                                element.style.display = 'none';
                                if (!removedElements.includes(elementId)) {
                                    removedElements.push(elementId);
                                }
                            } else {
                                // Element deselected - show it again
                                element.style.display = '';
                                removedElements = removedElements.filter(id => id !== elementId);
                            }
                        }
                    }
                });
                
                // Eye icon click handler (visibility toggle)
                $('.fa-eye').off('click').on('click', function(e) {
                    e.stopPropagation();
                    const elementId = $(this).closest('.removable-element').data('element-id');
                    console.log("Eye icon clicked for:", elementId);
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const element = iframeDoc.getElementById(elementId);
                    
                    if (element) {
                        if (element.style.display === 'none') {
                            // Show element
                            element.style.display = '';
                            $(this).removeClass('text-muted');
                            $(this).closest('.removable-element').removeClass('selected');
                            removedElements = removedElements.filter(id => id !== elementId);
                        } else {
                            // Hide element
                            element.style.display = 'none';
                            $(this).addClass('text-muted');
                            $(this).closest('.removable-element').addClass('selected');
                            if (!removedElements.includes(elementId)) {
                                removedElements.push(elementId);
                            }
                        }
                    }
                });
                
                // Edit icon click handler
                $('.fa-edit').off('click').on('click', function(e) {
                    e.stopPropagation();
                    const elementId = $(this).closest('.removable-element').data('element-id');
                    console.log("Edit icon clicked for:", elementId);
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const element = iframeDoc.getElementById(elementId);
                    
                    if (element) {
                        // Populate modal with element content
                        $('#editElementTitle').text(`Edit ${$(this).closest('.removable-element').find('span').text()}`);
                        $('#elementText').val(element.textContent || '');
                        $('#elementStyle').val(modifiedElements[elementId]?.style || '');
                        
                        // Store current element ID to use when saving
                        $('#editElementModal').data('element-id', elementId);
                        
                        // Show modal
                        const editModal = new bootstrap.Modal(document.getElementById('editElementModal'));
                        editModal.show();
                    }
                });
                
                // Element search functionality
                $('#elementSearch').off('input').on('input', function() {
                    const searchTerm = $(this).val().toLowerCase();
                    console.log("Searching for:", searchTerm);
                    
                    if (searchTerm === '') {
                        $('.element-category').show();
                        $('.removable-element').show();
                        return;
                    }
                    
                    $('.removable-element').each(function() {
                        const text = $(this).find('span').text().toLowerCase();
                        if (text.includes(searchTerm)) {
                            $(this).show();
                            $(this).closest('.element-category').show();
                        } else {
                            $(this).hide();
                        }
                    });
                    
                    // Hide categories with no visible elements
                    $('.element-category').each(function() {
                        const visibleElements = $(this).find('.removable-element:visible').length;
                        if (visibleElements === 0) {
                            $(this).hide();
                        }
                    });
                });
                
                // Category header click handler
                $('.element-category-header').off('click').on('click', function() {
                    const targetId = $(this).data('bs-target');
                    const targetElement = $(targetId);
                    console.log("Category header clicked:", targetId);
                    
                    // Toggle collapse manually (in case Bootstrap JS isn't working)
                    if (targetElement.hasClass('show')) {
                        targetElement.removeClass('show');
                        $(this).find('i').removeClass('fa-chevron-up').addClass('fa-chevron-down');
                    } else {
                        targetElement.addClass('show');
                        $(this).find('i').removeClass('fa-chevron-down').addClass('fa-chevron-up');
                    }
                });
                
                // Save element changes
                $('#saveElementChanges').off('click').on('click', function() {
                    const elementId = $('#editElementModal').data('element-id');
                    const newText = $('#elementText').val();
                    const newStyle = $('#elementStyle').val();
                    console.log("Saving changes for:", elementId);
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const element = iframeDoc.getElementById(elementId);
                    
                    if (element) {
                        // Update text content if it's not empty
                        if (newText.trim() !== '') {
                            element.textContent = newText;
                        }
                        
                        // Apply custom styles
                        if (newStyle.trim() !== '') {
                            element.style.cssText += newStyle;
                        }
                        
                        // Store modifications
                        modifiedElements[elementId] = {
                            text: newText,
                            style: newStyle
                        };
                    }
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editElementModal'));
                    if (modal) {
                        modal.hide();
                    }
                });
                
                // Color options
                $('.color-option').off('click').on('click', function() {
                    const colorSection = $(this).closest('div').prev('h5');
                    const colorType = colorSection.text().toLowerCase().split(' ')[0];
                    const color = $(this).data('color');
                    console.log("Color selected:", colorType, color);
                    
                    // Update selection UI
                    $(this).siblings('.color-option').removeClass('selected');
                    $(this).addClass('selected');
                    
                    // Update color input
                    $(`#custom${colorType.charAt(0).toUpperCase() + colorType.slice(1)}Color`).val(color);
                    
                    // Apply color to template
                    applyColorToTemplate(colorType, color);
                });
                
                // Custom color inputs
                $('input[type="color"]').off('change').on('change', function() {
                    const colorType = $(this).attr('id').replace('custom', '').replace('Color', '').toLowerCase();
                    const color = $(this).val();
                    console.log("Custom color changed:", colorType, color);
                    
                    // Deselect preset colors
                    $(this).siblings('.color-option').removeClass('selected');
                    
                    // Apply color to template
                    applyColorToTemplate(colorType, color);
                });
                
                // Font selectors
                $('#headingFont, #bodyFont').off('change').on('change', function() {
                    const fontType = $(this).attr('id').replace('Font', '');
                    const fontFamily = $(this).val();
                    console.log("Font changed:", fontType, fontFamily);
                    
                    // Update selected fonts
                    selectedFonts[fontType] = fontFamily;
                    
                    // Apply fonts to template
                    applyFontsToTemplate();
                });
                
                // Font size sliders
                $('#headingSize, #bodySize').off('input').on('input', function() {
                    const sizeType = $(this).attr('id').replace('Size', '');
                    const size = $(this).val() + 'px';
                    console.log("Font size changed:", sizeType, size);
                    
                    // Update display value
                    $(`#${sizeType}SizeValue`).text(size);
                    
                    // Update selected fonts
                    selectedFonts[sizeType + 'Size'] = size;
                    
                    // Apply fonts to template
                    applyFontsToTemplate();
                });
                
                // Media replace/remove buttons
                $('.replace-media').off('click').on('click', function() {
                    const mediaItem = $(this).closest('.media-item');
                    const mediaName = mediaItem.find('span').text();
                    console.log("Replace media clicked:", mediaName);
                    
                    // Trigger file upload dialog
                    $('#uploadMedia').click();
                    
                    // Store the media being replaced
                    $('#uploadMedia').data('replace-media', mediaName);
                });
                
                $('.remove-media').off('click').on('click', function() {
                    const mediaItem = $(this).closest('.media-item');
                    const mediaName = mediaItem.find('span').text();
                    console.log("Remove media clicked:", mediaName);
                    
                    // Store removal in modification list
                    modifiedMedia[mediaName] = { action: 'remove' };
                    
                    // Visual feedback
                    mediaItem.addClass('opacity-50');
                    $(this).text('Restore').removeClass('btn-outline-danger').addClass('btn-outline-success');
                    $(this).removeClass('remove-media').addClass('restore-media');
                    
                    // Actually remove the image from the iframe if possible
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const imageElements = iframeDoc.querySelectorAll('img');
                    imageElements.forEach(img => {
                        const src = img.src;
                        if (src.includes(mediaName) || img.alt === mediaName) {
                            // Hide the image
                            img.style.display = 'none';
                        }
                    });
                });
                
                // Restore media
                $(document).on('click', '.restore-media', function() {
                    const mediaItem = $(this).closest('.media-item');
                    const mediaName = mediaItem.find('span').text();
                    console.log("Restore media clicked:", mediaName);
                    
                    // Remove from modification list
                    delete modifiedMedia[mediaName];
                    
                    // Visual feedback
                    mediaItem.removeClass('opacity-50');
                    $(this).text('Remove').removeClass('btn-outline-success').addClass('btn-outline-danger');
                    $(this).removeClass('restore-media').addClass('remove-media');
                    
                    // Restore the image in the iframe if possible
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const imageElements = iframeDoc.querySelectorAll('img');
                    imageElements.forEach(img => {
                        const src = img.src;
                        if (src.includes(mediaName) || img.alt === mediaName) {
                            // Show the image again
                            img.style.display = '';
                        }
                    });
                });
                
                // Media upload button
                $('#uploadBtn').off('click').on('click', function() {
                    console.log("Upload button clicked");
                    const fileInput = document.getElementById('uploadMedia');
                    if (fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        const replaceMedia = $('#uploadMedia').data('replace-media');
                        
                        if (replaceMedia) {
                            // Handle replacement
                            modifiedMedia[replaceMedia] = {
                                action: 'replace',
                                file: file
                            };
                            
                            // Update UI to show replacement
                            $(`#mediaList .media-item span:contains('${replaceMedia}')`).closest('.media-item')
                                .find('img').attr('src', URL.createObjectURL(file));
                            
                            // Update the image in the iframe if possible
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const imageElements = iframeDoc.querySelectorAll('img');
                            const fileUrl = URL.createObjectURL(file);
                            
                            imageElements.forEach(img => {
                                const src = img.src;
                                if (src.includes(replaceMedia) || img.alt === replaceMedia) {
                                    img.src = fileUrl;
                                    img.style.display = ''; // Make sure it's visible
                                }
                            });
                            
                            // Clear data attribute
                            $('#uploadMedia').removeData('replace-media');
                        } else {
                            // Handle new upload
                            const newMediaName = file.name;
                            modifiedMedia[newMediaName] = {
                                action: 'add',
                                file: file
                            };
                            
                            // Add to media list
                            const newMediaItem = `
                                <div class="media-item">
                                    <img src="${URL.createObjectURL(file)}" alt="${newMediaName}">
                                    <div class="media-controls">
                                        <span>${newMediaName}</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary replace-media">Replace</button>
                                            <button class="btn btn-sm btn-outline-danger ms-2 remove-media">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            $('#mediaList').append(newMediaItem);
                        }
                        
                        // Reset file input
                        fileInput.value = '';
                    }
                });
            }
            
            // Reset button
            $('#resetBtn').off('click').on('click', function() {
                console.log("Reset button clicked");
                // Clear stored changes
                removedElements = [];
                modifiedElements = {};
                selectedColors = {
                    primary: '#4e73df',
                    secondary: '#858796',
                    background: '#ffffff'
                };
                selectedFonts = {
                    heading: "'Open Sans', sans-serif",
                    body: "'Helvetica Neue', Helvetica, sans-serif",
                    headingSize: '32px',
                    bodySize: '16px'
                };
                modifiedMedia = {};
                
                // Reset UI selections
                $('.removable-element').removeClass('selected');
                $('.color-option').removeClass('selected');
                
                // Reset color selections - fixed to properly select the first color in each section
                $('h5:contains("Primary Color")').next('div').find('.color-option').first().addClass('selected');
                $('h5:contains("Secondary Color")').next('div').find('.color-option').first().addClass('selected');
                $('h5:contains("Background Color")').next('div').find('.color-option').first().addClass('selected');
                
                $('#customPrimaryColor').val('#4e73df');
                $('#customSecondaryColor').val('#858796');
                $('#customBgColor').val('#ffffff');
                $('#headingFont').val("'Open Sans', sans-serif");
                $('#bodyFont').val("'Helvetica Neue', Helvetica, sans-serif");
                $('#headingSize').val(32);
                $('#bodySize').val(16);
                $('#headingSizeValue').text('32px');
                $('#bodySizeValue').text('16px');
                
                // Reset media items UI
                $('.media-item').removeClass('opacity-50');
                $('.restore-media').text('Remove').removeClass('btn-outline-success').addClass('btn-outline-danger').removeClass('restore-media').addClass('remove-media');
                
                // Reload iframe to reset all changes
                iframe.src = iframe.src;
            });
            
            // Preview button
            $('#previewBtn').off('click').on('click', function() {
                console.log("Preview button clicked");
                // Apply all customizations to a full page preview
                alert('Preview would open a new tab with all customizations applied');
            });
            
            // Generate ZIP button
            $('#generateZipBtn').off('click').on('click', function() {
                console.log("Generate ZIP button clicked");
                // Clear previous inputs
                $('#zipForm').empty();
                
                // Add template_id
                $('#zipForm').append(`<input type="hidden" name="template_id" value="1">`);
                
                // Add removed elements
                removedElements.forEach(function(elementId) {
                    $('#zipForm').append(`<input type="hidden" name="customization[removed][]" value="${elementId}">`);
                });
                
                // Add modified elements
                for (const [elementId, modifications] of Object.entries(modifiedElements)) {
                    if (modifications.text) {
                        $('#zipForm').append(`<input type="hidden" name="customization[modified][${elementId}][text]" value="${modifications.text.replace(/"/g, '&quot;')}">`);
                    }
                    if (modifications.style) {
                        $('#zipForm').append(`<input type="hidden" name="customization[modified][${elementId}][style]" value="${modifications.style.replace(/"/g, '&quot;')}">`);
                    }
                }
                
                // Add colors
                for (const [colorType, color] of Object.entries(selectedColors)) {
                    $('#zipForm').append(`<input type="hidden" name="customization[colors][${colorType}]" value="${color}">`);
                }
                
                // Add fonts
                for (const [fontType, fontValue] of Object.entries(selectedFonts)) {
                    $('#zipForm').append(`<input type="hidden" name="customization[fonts][${fontType}]" value="${fontValue.replace(/"/g, '&quot;')}">`);
                }
                
                console.log("Form data prepared:", $('#zipForm').serializeArray());
                
                // Submit the form
                $('#zipForm').submit();
            });
            
            function applyColorToTemplate(type, color) {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (!iframeDoc) return;
                
                // Store selected color
                selectedColors[type] = color;
                
                // Apply colors based on type
                switch(type) {
                    case 'primary':
                        // Apply to primary elements (buttons, accents, etc.)
                        const primaryElements = iframeDoc.querySelectorAll('.btn-primary, .primary-color, .navbar, .bg-primary');
                        primaryElements.forEach(el => {
                            el.style.backgroundColor = color;
                            el.style.borderColor = color;
                        });
                        
                        // Apply to text elements
                        const primaryTextElements = iframeDoc.querySelectorAll('.text-primary');
                        primaryTextElements.forEach(el => {
                            el.style.color = color;
                        });
                        break;
                        
                    case 'secondary':
                        // Apply to secondary elements
                        const secondaryElements = iframeDoc.querySelectorAll('.btn-secondary, .secondary-color, .bg-secondary');
                        secondaryElements.forEach(el => {
                            el.style.backgroundColor = color;
                            el.style.borderColor = color;
                        });
                        
                        // Apply to text elements
                        const secondaryTextElements = iframeDoc.querySelectorAll('.text-secondary');
                        secondaryTextElements.forEach(el => {
                            el.style.color = color;
                        });
                        break;
                        
                    case 'background':
                        // Apply to body and background elements
                        if (iframeDoc.body) {
                            iframeDoc.body.style.backgroundColor = color;
                        }
                        const bgElements = iframeDoc.querySelectorAll('.bg-light, .bg-white');
                        bgElements.forEach(el => {
                            el.style.backgroundColor = color;
                        });
                        break;
                }
            }
            
            function applyFontsToTemplate() {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (!iframeDoc) return;
                
                // Create style element if it doesn't exist
                let styleEl = iframeDoc.getElementById('custom-fonts');
                if (!styleEl) {
                    styleEl = iframeDoc.createElement('style');
                    styleEl.id = 'custom-fonts';
                    iframeDoc.head.appendChild(styleEl);
                }
                
                // Define CSS rules
                const css = `
                    h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
                        font-family: ${selectedFonts.heading} !important;
                    }
                    
                    h1, .h1 { font-size: ${selectedFonts.headingSize} !important; }
                    h2, .h2 { font-size: calc(${selectedFonts.headingSize} * 0.8) !important; }
                    h3, .h3 { font-size: calc(${selectedFonts.headingSize} * 0.7) !important; }
                    h4, .h4 { font-size: calc(${selectedFonts.headingSize} * 0.6) !important; }
                    
                    body, p, div, span, a, input, button, textarea, select, .body-text {
                        font-family: ${selectedFonts.body} !important;
                    }
                    
                    body, p, .body-text {
                        font-size: ${selectedFonts.bodySize} !important;
                    }
                `;
                
                // Apply CSS
                styleEl.textContent = css;
            }
        });
    </script>

</body>

</html>
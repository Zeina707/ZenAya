<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Template Customizer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .element-actions {
            display: flex;
            gap: 8px;
        }

        .element-actions button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .element-actions button:hover {
            opacity: 0.8;
        }

        .btn-trash {
            color: #dc3545;
        }

        .btn-trash:hover {
            color: #c82333;
            transform: scale(1.1);
            transition: transform 0.2s;
        }

        .template-preview {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            height: 600px;
            overflow: auto;
        }
        
        .template-preview iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .element-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .element-category {
            margin-bottom: 15px;
        }
        
        .element-category-header {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .element-items {
            padding-left: 15px;
        }
        
        .removable-element {
            cursor: default;
            padding: 8px;
            margin: 5px 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .removable-element:hover {
            background: #f1f1f1;
        }
        
        .removable-element.removed {
            background: #f8d7da;
            border-color: #f5c6cb;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .preview-controls {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .tab-content {
            padding-top: 15px;
        }
        
        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 5px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .color-option.selected {
            border-color: #333;
        }
        
        .media-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .media-item img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        
        .media-controls {
            display: flex;
            justify-content: space-between;
        }
        
        .btn-restore {
            color: #28a745;
        }
        
        .btn-restore:hover {
            color: #218838;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">Advanced Template Customizer</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="template-preview" id="previewContainer">
                    <iframe id="templatePreview" src="/template1"></iframe>
                </div>
                
                <div class="preview-controls">
                    <button class="btn btn-secondary" id="resetBtn">Reset Changes</button>
                    <div>
                        <button class="btn btn-success me-2" id="previewBtn">Preview</button>
                        <button class="btn btn-primary" id="generateZipBtn">Generate ZIP</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="controls">
                    <ul class="nav nav-tabs" id="customizeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="elements-tab" data-bs-toggle="tab" data-bs-target="#elements" type="button" role="tab">Elements</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="colors-tab" data-bs-toggle="tab" data-bs-target="#colors" type="button" role="tab">Colors</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button" role="tab">Media</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fonts-tab" data-bs-toggle="tab" data-bs-target="#fonts" type="button" role="tab">Fonts</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="customizeTabsContent">
                        <!-- Elements Tab -->
                        <div class="tab-pane fade show active" id="elements" role="tabpanel">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="elementSearch" placeholder="Search elements...">
                            </div>
                            
                            <div class="element-list" id="elementList">
                                <!-- Header Elements -->
                                <div class="element-category">
                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#headerElements">
                                        <span>Header</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="collapse show element-items" id="headerElements">
                                        <div class="removable-element" data-element-id="header-logo">
                                            <span>Logo</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="header-nav">
                                            <span>Navigation Menu</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="header-cta">
                                            <span>Call-to-Action Button</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hero Section Elements -->
                                <div class="element-category">
                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#heroElements">
                                        <span>Hero Section</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="collapse show element-items" id="heroElements">
                                        <div class="removable-element" data-element-id="hero-heading">
                                            <span>Main Heading</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="hero-subheading">
                                            <span>Subheading</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="hero-image">
                                            <span>Hero Image</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="hero-cta">
                                            <span>Call-to-Action Button</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- About Section Elements -->
                                <div class="element-category">
                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#aboutElements">
                                        <span>About Section</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="collapse show element-items" id="aboutElements">
                                        <div class="removable-element" data-element-id="about-heading">
                                            <span>Heading</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="about-text">
                                            <span>Description Text</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="about-image">
                                            <span>Image</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Footer Elements -->
                                <div class="element-category">
                                    <div class="element-category-header" data-bs-toggle="collapse" data-bs-target="#footerElements">
                                        <span>Footer</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="collapse show element-items" id="footerElements">
                                        <div class="removable-element" data-element-id="footer-logo">
                                            <span>Logo</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="footer-links">
                                            <span>Navigation Links</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="footer-social">
                                            <span>Social Media Icons</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div class="removable-element" data-element-id="footer-copyright">
                                            <span>Copyright Text</span>
                                            <div class="element-actions">
                                                <button class="btn-trash"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Colors Tab -->
                        <div class="tab-pane fade" id="colors" role="tabpanel">
                            <h5>Primary Color</h5>
                            <div class="mb-3">
                                <div class="color-option selected" style="background-color: #4e73df;" data-color="#4e73df"></div>
                                <div class="color-option" style="background-color: #1cc88a;" data-color="#1cc88a"></div>
                                <div class="color-option" style="background-color: #36b9cc;" data-color="#36b9cc"></div>
                                <div class="color-option" style="background-color: #f6c23e;" data-color="#f6c23e"></div>
                                <div class="color-option" style="background-color: #e74a3b;" data-color="#e74a3b"></div>
                                <div class="color-option" style="background-color: #5a5c69;" data-color="#5a5c69"></div>
                                <input type="color" id="customPrimaryColor" class="form-control form-control-sm mt-2" value="#4e73df">
                            </div>
                            
                            <h5>Secondary Color</h5>
                            <div class="mb-3">
                                <div class="color-option selected" style="background-color: #858796;" data-color="#858796"></div>
                                <div class="color-option" style="background-color: #f8f9fc;" data-color="#f8f9fc"></div>
                                <div class="color-option" style="background-color: #e3e6f0;" data-color="#e3e6f0"></div>
                                <div class="color-option" style="background-color: #d1d3e2;" data-color="#d1d3e2"></div>
                                <div class="color-option" style="background-color: #b7b9cc;" data-color="#b7b9cc"></div>
                                <input type="color" id="customSecondaryColor" class="form-control form-control-sm mt-2" value="#858796">
                            </div>
                            
                            <h5>Background Color</h5>
                            <div>
                                <div class="color-option selected" style="background-color: #ffffff;" data-color="#ffffff"></div>
                                <div class="color-option" style="background-color: #f8f9fc;" data-color="#f8f9fc"></div>
                                <div class="color-option" style="background-color: #f0f0f0;" data-color="#f0f0f0"></div>
                                <div class="color-option" style="background-color: #eeeeee;" data-color="#eeeeee"></div>
                                <input type="color" id="customBgColor" class="form-control form-control-sm mt-2" value="#ffffff">
                            </div>
                        </div>
                        
                        <!-- Media Tab -->
                        <div class="tab-pane fade" id="media" role="tabpanel">
                            <div class="mb-3">
                                <label for="uploadMedia" class="form-label">Upload New Media</label>
                                <input class="form-control" type="file" id="uploadMedia">
                                <button class="btn btn-outline-primary btn-sm mt-2" id="uploadBtn">Upload</button>
                            </div>
                            
                            <h5 class="mb-3">Template Media</h5>
                            <div id="mediaList">
                                <div class="media-item">
                                    <img src="/api/placeholder/150/100" alt="Hero Image">
                                    <div class="media-controls">
                                        <span>hero-image.jpg</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary replace-media">Replace</button>
                                            <button class="btn btn-sm btn-outline-danger ms-2 remove-media">Remove</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="media-item">
                                    <img src="/api/placeholder/150/100" alt="About Image">
                                    <div class="media-controls">
                                        <span>about-image.jpg</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary replace-media">Replace</button>
                                            <button class="btn btn-sm btn-outline-danger ms-2 remove-media">Remove</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="media-item">
                                    <img src="/api/placeholder/150/100" alt="Logo">
                                    <div class="media-controls">
                                        <span>logo.png</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary replace-media">Replace</button>
                                            <button class="btn btn-sm btn-outline-danger ms-2 remove-media">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fonts Tab -->
                        <div class="tab-pane fade" id="fonts" role="tabpanel">
                            <div class="mb-3">
                                <label for="headingFont" class="form-label">Heading Font</label>
                                <select class="form-select" id="headingFont">
                                    <option value="Arial, sans-serif">Arial</option>
                                    <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                                    <option value="'Open Sans', sans-serif" selected>Open Sans</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Lato', sans-serif">Lato</option>
                                    <option value="Georgia, serif">Georgia</option>
                                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="bodyFont" class="form-label">Body Font</label>
                                <select class="form-select" id="bodyFont">
                                    <option value="Arial, sans-serif">Arial</option>
                                    <option value="'Helvetica Neue', Helvetica, sans-serif" selected>Helvetica</option>
                                    <option value="'Open Sans', sans-serif">Open Sans</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Lato', sans-serif">Lato</option>
                                    <option value="Georgia, serif">Georgia</option>
                                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="headingSize" class="form-label">Heading Size</label>
                                <div class="input-group">
                                    <input type="range" class="form-range" id="headingSize" min="16" max="72" value="32">
                                    <span class="ms-2" id="headingSizeValue">32px</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="bodySize" class="form-label">Body Text Size</label>
                                <div class="input-group">
                                    <input type="range" class="form-range" id="bodySize" min="12" max="24" value="16">
                                    <span class="ms-2" id="bodySizeValue">16px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="zipForm" action="/generate-zip" method="post" style="display:none;">
                    <input type="hidden" name="template_id" value="1">
                    <!-- Hidden inputs for customization options will be added dynamically -->
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script>
$(document).ready(function() {
    // Store original iframe content and customization state
    let iframe = document.getElementById('templatePreview');
    let removedElements = [];
    let selectedColors = {
        primary: '#4e73df',
        secondary: '#858796',
        background: '#ffffff'
    };
    let selectedFonts = {
        heading: "'Open Sans', sans-serif",
        body: "'Helvetica Neue', Helvetica, sans-serif",
        headingSize: '32px',
        bodySize: '16px'
    };
    let modifiedMedia = {};
    
    // Initialize customizer functionality
    if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
        initializeCustomizer();
    } else {
        iframe.onload = function() {
            initializeCustomizer();
        };
    }
    
    function initializeCustomizer() {
        console.log("Initializing customizer...");
        
        // Trash button click handler
        $(document).on('click', '.btn-trash', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const elementItem = $(this).closest('.removable-element');
            const elementId = elementItem.data('element-id');
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const element = iframeDoc.getElementById(elementId);
            
            if (element) {
                const icon = $(this).find('i');
                if (elementItem.hasClass('removed')) {
                    element.style.display = '';
                    elementItem.removeClass('removed');
                    icon.removeClass('fa-undo').addClass('fa-trash-alt');
                    removedElements = removedElements.filter(id => id !== elementId);
                } else {
                    element.style.display = 'none';
                    elementItem.addClass('removed');
                    icon.removeClass('fa-trash-alt').addClass('fa-undo');
                    if (!removedElements.includes(elementId)) {
                        removedElements.push(elementId);
                    }
                }
            }
        });
        
        // Element search functionality
        $('#elementSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            console.log("Searching for:", searchTerm);
            
            if (searchTerm === '') {
                $('.element-category').show();
                $('.removable-element').show();
                return;
            }
            
            $('.removable-element').each(function() {
                const text = $(this).find('span').text().toLowerCase();
                if (text.includes(searchTerm)) {
                    $(this).show();
                    $(this).closest('.element-category').show();
                } else {
                    $(this).hide();
                }
            });
            
            // Hide categories with no visible elements
            $('.element-category').each(function() {
                const visibleElements = $(this).find('.removable-element:visible').length;
                if (visibleElements === 0) {
                    $(this).hide();
                }
            });
        });
        
        // Category header click handler
        $(document).on('click', '.element-category-header', function() {
            const targetId = $(this).data('bs-target');
            const targetElement = $(targetId);
            console.log("Category header clicked:", targetId);
            
            // Toggle collapse manually (in case Bootstrap JS isn't working)
            if (targetElement.hasClass('show')) {
                targetElement.removeClass('show');
                $(this).find('i').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                targetElement.addClass('show');
                $(this).find('i').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        });
        
        // Color options
        $(document).on('click', '.color-option', function() {
            const colorSection = $(this).closest('div').prev('h5');
            const colorType = colorSection.text().toLowerCase().split(' ')[0];
            const color = $(this).data('color');
            console.log("Color selected:", colorType, color);
            
            // Update selection UI
            $(this).siblings('.color-option').removeClass('selected');
            $(this).addClass('selected');
            
            // Update color input
            $(`#custom${colorType.charAt(0).toUpperCase() + colorType.slice(1)}Color`).val(color);
            
            // Apply color to template
            applyColorToTemplate(colorType, color);
        });
        
        // Custom color inputs
        $('input[type="color"]').on('change', function() {
            const colorType = this.id.replace('custom', '').replace('Color', '').toLowerCase();
            const color = $(this).val();
            console.log("Custom color changed:", colorType, color);
            
            // Update selected color
            selectedColors[colorType] = color;
            
            // Apply color to template
            applyColorToTemplate(colorType, color);
        });
        
        // Apply color to template elements
        function applyColorToTemplate(colorType, color) {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            switch(colorType) {
                case 'primary':
                    selectedColors.primary = color;
                    
                    // Update primary colored elements
                    const primaryElements = iframeDoc.querySelectorAll('.btn-primary, .primary-color, .primary-bg');
                    primaryElements.forEach(el => {
                        if(el.classList.contains('primary-bg')) {
                            el.style.backgroundColor = color;
                        } else if(el.classList.contains('primary-color')) {
                            el.style.color = color;
                        } else {
                            el.style.backgroundColor = color;
                            el.style.borderColor = color;
                        }
                    });
                    break;
                    
                case 'secondary':
                    selectedColors.secondary = color;
                    
                    // Update secondary colored elements
                    const secondaryElements = iframeDoc.querySelectorAll('.btn-secondary, .secondary-color, .secondary-bg');
                    secondaryElements.forEach(el => {
                        if(el.classList.contains('secondary-bg')) {
                            el.style.backgroundColor = color;
                        } else if(el.classList.contains('secondary-color')) {
                            el.style.color = color;
                        } else {
                            el.style.backgroundColor = color;
                            el.style.borderColor = color;
                        }
                    });
                    break;
                    
                case 'background':
                    selectedColors.background = color;
                    
                    // Update background colored elements
                    iframeDoc.body.style.backgroundColor = color;
                    const bgElements = iframeDoc.querySelectorAll('.bg-light, .background-color');
                    bgElements.forEach(el => {
                        el.style.backgroundColor = color;
                    });
                    break;
            }
        }
        
        // Font controls
        $('#headingFont').on('change', function() {
            const fontFamily = $(this).val();
            console.log("Heading font changed:", fontFamily);
            selectedFonts.heading = fontFamily;
            applyFontsToTemplate();
        });
        
        $('#bodyFont').on('change', function() {
            const fontFamily = $(this).val();
            console.log("Body font changed:", fontFamily);
            selectedFonts.body = fontFamily;
            applyFontsToTemplate();
        });
        
        $('#headingSize').on('input', function() {
            const size = $(this).val() + 'px';
            $('#headingSizeValue').text(size);
            selectedFonts.headingSize = size;
            applyFontsToTemplate();
        });
        
        $('#bodySize').on('input', function() {
            const size = $(this).val() + 'px';
            $('#bodySizeValue').text(size);
            selectedFonts.bodySize = size;
            applyFontsToTemplate();
        });
        
        function applyFontsToTemplate() {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // Apply heading fonts
            const headings = iframeDoc.querySelectorAll('h1, h2, h3, h4, h5, h6, .heading-font');
            headings.forEach(el => {
                el.style.fontFamily = selectedFonts.heading;
                el.style.fontSize = selectedFonts.headingSize;
            });
            
            // Apply body fonts
            const bodyElements = iframeDoc.querySelectorAll('p, span, a, div:not(.heading-font), li');
            bodyElements.forEach(el => {
                // Skip elements that already have heading font applied
                if(!el.classList.contains('heading-font') && 
                   !el.closest('h1, h2, h3, h4, h5, h6, .heading-font')) {
                    el.style.fontFamily = selectedFonts.body;
                    el.style.fontSize = selectedFonts.bodySize;
                }
            });
        }
        
        // Media handling
        $('.replace-media').click(function() {
            const mediaItem = $(this).closest('.media-item');
            const mediaName = mediaItem.find('span').text();
            console.log("Replace media clicked for:", mediaName);
            
            // Trigger file input click
            $('#uploadMedia').click();
            
            // Store reference to current media item for later use
            $('#uploadMedia').data('target-media', mediaName);
        });
        
        $('.remove-media').click(function() {
            const mediaItem = $(this).closest('.media-item');
            const mediaName = mediaItem.find('span').text();
            console.log("Remove media clicked for:", mediaName);
            
            // Mark media as removed in UI
            mediaItem.addClass('removed');
            $(this).text('Restore').removeClass('btn-outline-danger remove-media').addClass('btn-outline-success restore-media');
            
            // Update iframe - find and hide all instances of this image
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const images = iframeDoc.querySelectorAll(`img[src*="${mediaName}"], img[alt="${mediaName}"]`);
            images.forEach(img => {
                img.style.display = 'none';
            });
            
            // Add to modified media
            modifiedMedia[mediaName] = {
                action: 'remove'
            };
        });
        
        // Restore removed media
        $(document).on('click', '.restore-media', function() {
            const mediaItem = $(this).closest('.media-item');
            const mediaName = mediaItem.find('span').text();
            console.log("Restore media clicked for:", mediaName);
            
            // Update UI
            mediaItem.removeClass('removed');
            $(this).text('Remove').removeClass('btn-outline-success restore-media').addClass('btn-outline-danger remove-media');
            
            // Update iframe - restore all instances of this image
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const images = iframeDoc.querySelectorAll(`img[src*="${mediaName}"], img[alt="${mediaName}"]`);
            images.forEach(img => {
                img.style.display = '';
            });
            
            // Remove from modified media or update action
            if(modifiedMedia[mediaName]) {
                if(modifiedMedia[mediaName].action === 'remove') {
                    delete modifiedMedia[mediaName];
                } else {
                    modifiedMedia[mediaName].action = 'replace';
                }
            }
        });
        
        // Handle file upload
        $('#uploadMedia').change(function() {
            const file = this.files[0];
            if(!file) return;
            
            const targetMedia = $(this).data('target-media');
            console.log("File selected for upload:", file.name, "Target:", targetMedia);
            
            // In a real app, we would upload the file to the server here
            // For demo purposes, we'll just simulate a successful upload
            
            // Store the media change
            modifiedMedia[targetMedia] = {
                action: 'replace',
                newFile: file.name
            };
            
            // Update UI to show the new file name
            const mediaItem = $(`#mediaList span:contains("${targetMedia}")`).closest('.media-item');
            
            // Create a local preview of the image
            const reader = new FileReader();
            reader.onload = function(e) {
                mediaItem.find('img').attr('src', e.target.result);
                
                // Also update any instances in the iframe
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const images = iframeDoc.querySelectorAll(`img[src*="${targetMedia}"], img[alt="${targetMedia}"]`);
                images.forEach(img => {
                    img.src = e.target.result;
                });
            };
            reader.readAsDataURL(file);
        });
        
        // Upload button click handler
        $('#uploadBtn').click(function() {
            $('#uploadMedia').click();
        });
        
        // Reset button click handler
        $('#resetBtn').click(function() {
            console.log("Reset changes clicked");
            
            // Reset removed elements
            removedElements.forEach(elementId => {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const element = iframeDoc.getElementById(elementId);
                if(element) {
                    element.style.display = '';
                }
                
                // Update UI
                const elementItem = $(`.removable-element[data-element-id="${elementId}"]`);
                elementItem.removeClass('removed');
                elementItem.find('.btn-trash').removeClass('fa-undo').addClass('fa-trash-alt');
            });
            removedElements = [];
            
            // Reset colors
            selectedColors = {
                primary: '#4e73df',
                secondary: '#858796',
                background: '#ffffff'
            };
            $('#customPrimaryColor').val('#4e73df');
            $('#customSecondaryColor').val('#858796');
            $('#customBgColor').val('#ffffff');
            
            // Reset font selections
            selectedFonts = {
                heading: "'Open Sans', sans-serif",
                body: "'Helvetica Neue', Helvetica, sans-serif",
                headingSize: '32px',
                bodySize: '16px'
            };
            $('#headingFont').val("'Open Sans', sans-serif");
            $('#bodyFont').val("'Helvetica Neue', Helvetica, sans-serif");
            $('#headingSize').val(32);
            $('#headingSizeValue').text('32px');
            $('#bodySize').val(16);
            $('#bodySizeValue').text('16px');
            
            // Reset media changes
            for(const mediaName in modifiedMedia) {
                if(modifiedMedia[mediaName].action === 'remove') {
                    // Restore hidden images
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const images = iframeDoc.querySelectorAll(`img[src*="${mediaName}"], img[alt="${mediaName}"]`);
                    images.forEach(img => {
                        img.style.display = '';
                    });
                    
                    // Update UI
                    const mediaItem = $(`#mediaList span:contains("${mediaName}")`).closest('.media-item');
                    mediaItem.removeClass('removed');
                    const button = mediaItem.find('button.restore-media');
                    if(button.length) {
                        button.text('Remove').removeClass('btn-outline-success restore-media').addClass('btn-outline-danger remove-media');
                    }
                }
                // For replaced media, we'd need to reset to original images
                // This would require saving original sources
            }
            modifiedMedia = {};
            
            // Reload iframe to get a fresh start
            iframe.src = iframe.src;
        });
        
        // Preview button click handler
        $('#previewBtn').click(function() {
            console.log("Preview changes clicked");
            
            // Create a summary of changes
            let summary = "Changes Preview:\n\n";
            
            if(removedElements.length > 0) {
                summary += "Removed Elements:\n";
                removedElements.forEach(id => {
                    summary += `- ${id}\n`;
                });
                summary += "\n";
            }
            
            summary += "Selected Colors:\n";
            summary += `- Primary: ${selectedColors.primary}\n`;
            summary += `- Secondary: ${selectedColors.secondary}\n`;
            summary += `- Background: ${selectedColors.background}\n\n`;
            
            summary += "Selected Fonts:\n";
            summary += `- Heading: ${selectedFonts.heading} (${selectedFonts.headingSize})\n`;
            summary += `- Body: ${selectedFonts.body} (${selectedFonts.bodySize})\n\n`;
            
            if(Object.keys(modifiedMedia).length > 0) {
                summary += "Media Changes:\n";
                for(const name in modifiedMedia) {
                    if(modifiedMedia[name].action === 'remove') {
                        summary += `- ${name}: Removed\n`;
                    } else {
                        summary += `- ${name}: Replaced with ${modifiedMedia[name].newFile}\n`;
                    }
                }
            }
            
                
                // Display summary in an alert (in a real app, this would be a nicer modal)
                alert(summary);
            });
            
            // Generate ZIP button click handler
            $('#generateZipBtn').click(function() {
                console.log("Generate ZIP clicked");
                
                // In a real app, we would submit this form with all the customization data
                // For demo purposes, we'll simulate form submission with dummy data
                
                // Prepare form data
                const form = $('#zipForm');
                
                // Clear any existing hidden inputs
                form.find('input[type="hidden"]').not('[name="template_id"]').remove();
                
                // Add removed elements
                if(removedElements.length > 0) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'removed_elements',
                        value: JSON.stringify(removedElements)
                    }).appendTo(form);
                }
                
                // Add modified elements
                if(Object.keys(modifiedElements).length > 0) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'modified_elements',
                        value: JSON.stringify(modifiedElements)
                    }).appendTo(form);
                }
                
                // Add colors
                $('<input>').attr({
                    type: 'hidden',
                    name: 'colors',
                    value: JSON.stringify(selectedColors)
                }).appendTo(form);
                
                // Add fonts
                $('<input>').attr({
                    type: 'hidden',
                    name: 'fonts',
                    value: JSON.stringify(selectedFonts)
                }).appendTo(form);
                
                // Add media changes
                if(Object.keys(modifiedMedia).length > 0) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'media_changes',
                        value: JSON.stringify(modifiedMedia)
                    }).appendTo(form);
                }
                
                // Submit form
                form.submit();
            });
        }
    });
    </script>
</body>
</html>
        
       
       